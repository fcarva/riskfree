generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProjectStatus {
  DRAFT
  IN_ANALYSIS
  IN_REVIEW
  APPROVED
  IMPLEMENTATION
  COMPLETED
}

enum MachineStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum RiskLevel {
  VERY_LOW
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  VERIFIED
}

enum Role {
  ADMIN
  ENGINEER
  TECHNICIAN
  CLIENT
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  passwordHash  String
  role          Role     @default(ENGINEER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  projects      Project[]
  auditLogs     AuditLog[]
}

model Project {
  id            String         @id @default(cuid())
  name          String
  clientName    String
  clientCNPJ    String?
  site          String?
  responsible   String
  crea          String
  startDate     DateTime
  endDate       DateTime?
  status        ProjectStatus @default(DRAFT)
  type          String[]
  observations  String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  machines      Machine[]
  documents     Document[]
  actions       Action[]
  checklistRuns ChecklistResponse[]
}

model Machine {
  id              String        @id @default(cuid())
  tag             String
  name            String
  manufacturer    String?
  model           String?
  serialNumber    String?
  yearManufacture Int?
  location        String?
  status          MachineStatus @default(ACTIVE)
  lastMaintenance DateTime?
  responsible     String?
  images          String[]
  manualUrl       String?
  qrCode          String?
  projectId       String
  project         Project       @relation(fields: [projectId], references: [id])
  hazards         Hazard[]
  fmeas           FMEA[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model Hazard {
  id                 String    @id @default(cuid())
  description        String
  operationPhase     String
  hazardType         String
  zone               String?
  likelihoodValue    Float
  frequencyValue     Float
  severityValue      Float
  hrnScore           Float
  riskLevel          RiskLevel
  controlMeasures    String[]
  controlDetails     String?
  residualLikelihood Float?
  residualFrequency  Float?
  residualSeverity   Float?
  residualHRN        Float?
  residualRiskLevel  RiskLevel?
  machineId          String
  machine            Machine   @relation(fields: [machineId], references: [id])
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model FMEA {
  id                String   @id @default(cuid())
  component         String
  function          String
  failureMode       String
  effects           String
  severity          Int
  causes            String
  occurrence        Int
  currentControls   String?
  detection         Int
  rpn               Int
  recommendedActions String?
  responsible       String?
  deadline          DateTime?
  actionsTaken      String?
  newSeverity       Int?
  newOccurrence     Int?
  newDetection      Int?
  newRPN            Int?
  machineId         String
  machine           Machine  @relation(fields: [machineId], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Action {
  id             String       @id @default(cuid())
  description    String
  machineTag     String?
  type           String
  priority       Priority     @default(MEDIUM)
  responsible    String
  deadline       DateTime
  status         ActionStatus @default(PENDING)
  estimatedCost  Float?
  supplier       String?
  evidenceBefore String[]
  evidenceAfter  String[]
  comments       String?
  projectId      String
  project        Project      @relation(fields: [projectId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Document {
  id          String   @id @default(cuid())
  name        String
  type        String
  fileUrl     String
  size        Int
  mimeType    String
  version     Int      @default(1)
  tags        String[]
  description String?
  uploadedBy  String
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ChecklistTemplate {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  standard    String
  sections    Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  responses   ChecklistResponse[]
}

model ChecklistResponse {
  id            String            @id @default(cuid())
  answers       Json
  score         Float?
  projectId     String
  project       Project           @relation(fields: [projectId], references: [id])
  templateId    String
  template      ChecklistTemplate @relation(fields: [templateId], references: [id])
  createdById   String
  createdBy     User              @relation(fields: [createdById], references: [id])
  createdAt     DateTime          @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id])
  action    String
  target    String
  createdAt DateTime @default(now())
  metadata  Json?
}
